name: Deploy

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed
    branches:
      - main

permissions:
  actions: read
  contents: read

env:
  DOCKER_REGISTRY: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  check-changes:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      account: ${{ steps.changes.outputs.account }}
      api-gateway: ${{ steps.changes.outputs.api-gateway }}
      ptm-task: ${{ steps.changes.outputs.ptm-task }}
      ptm-schedule: ${{ steps.changes.outputs.ptm-schedule }}
      ptm-optimization: ${{ steps.changes.outputs.ptm-optimization }}
      crm: ${{ steps.changes.outputs.crm }}
      serp-web: ${{ steps.changes.outputs.serp-web }}
      purchase: ${{ steps.changes.outputs.purchase }}
      logistics: ${{ steps.changes.outputs.logistics }}
      sales: ${{ steps.changes.outputs.sales }}
      notification: ${{ steps.changes.outputs.notification }}
    steps:
      - name: Download changes artifact
        uses: actions/download-artifact@v4
        with:
          name: build-changes
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read changes
        id: changes
        run: |
          echo "account=$(jq -r .account changes.json)" >> $GITHUB_OUTPUT
          echo "api-gateway=$(jq -r '."api-gateway"' changes.json)" >> $GITHUB_OUTPUT
          echo "ptm-task=$(jq -r '."ptm-task"' changes.json)" >> $GITHUB_OUTPUT
          echo "ptm-schedule=$(jq -r '."ptm-schedule"' changes.json)" >> $GITHUB_OUTPUT
          echo "ptm-optimization=$(jq -r '."ptm-optimization"' changes.json)" >> $GITHUB_OUTPUT
          echo "crm=$(jq -r .crm changes.json)" >> $GITHUB_OUTPUT
          echo "serp-web=$(jq -r '."serp-web"' changes.json)" >> $GITHUB_OUTPUT
          echo "purchase=$(jq -r .purchase changes.json)" >> $GITHUB_OUTPUT
          echo "logistics=$(jq -r .logistics changes.json)" >> $GITHUB_OUTPUT
          echo "sales=$(jq -r .sales changes.json)" >> $GITHUB_OUTPUT
          echo "notification=$(jq -r .notification changes.json)" >> $GITHUB_OUTPUT

  deploy-account:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.account == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Account Service
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/serp_account
            export IMAGE_TAG=${{ github.sha }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

  deploy-api-gateway:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.api-gateway == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy API Gateway
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/api_gateway
            export IMAGE_TAG=${{ github.sha }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

  deploy-ptm-task:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.ptm-task == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy PTM Task
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/ptm_task
            export IMAGE_TAG=${{ github.sha }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

  deploy-ptm-schedule:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.ptm-schedule == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy PTM Schedule
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/ptm_schedule
            export IMAGE_TAG=${{ github.sha }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

  deploy-ptm-optimization:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.ptm-optimization == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy PTM Optimization
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/ptm_optimization
            export IMAGE_TAG=${{ github.sha }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

  deploy-crm:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.crm == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy CRM Service
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/crm
            export IMAGE_TAG=${{ github.sha }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

  deploy-serp-web:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.serp-web == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Serp Web (Next.js)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/serp_web
            export IMAGE_TAG=${{ github.sha }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

  deploy-purchase:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.purchase == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Purchase Service
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/serp_purchase
            export IMAGE_TAG=${{ github.sha }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

  deploy-logistics:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.logistics == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Logistics
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/serp_logistics
            export IMAGE_TAG=${{ github.sha }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

  deploy-sales:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.sales == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Sales
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/serp_sales
            export IMAGE_TAG=${{ github.sha }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

  deploy-notification:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.notification == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Notification Service
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/serp_notification
            export IMAGE_TAG=${{ github.sha }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

  notify-deployment:
    needs: check-changes
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "Deployment completed for changed services" >> $GITHUB_STEP_SUMMARY
          echo "- Account: ${{ needs.check-changes.outputs.account }}" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway: ${{ needs.check-changes.outputs.api-gateway }}" >> $GITHUB_STEP_SUMMARY
          echo "- PTM Task: ${{ needs.check-changes.outputs.ptm-task }}" >> $GITHUB_STEP_SUMMARY
          echo "- PTM Schedule: ${{ needs.check-changes.outputs.ptm-schedule }}" >> $GITHUB_STEP_SUMMARY
          echo "- PTM Optimization: ${{ needs.check-changes.outputs.ptm-optimization }}" >> $GITHUB_STEP_SUMMARY
          echo "- CRM: ${{ needs.check-changes.outputs.crm }}" >> $GITHUB_STEP_SUMMARY
          echo "- Serp Web: ${{ needs.check-changes.outputs.serp-web }}" >> $GITHUB_STEP_SUMMARY
